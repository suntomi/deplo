# generated by deplo CLI https://github.com/suntomi/deplo don't edit by hand.
name: Deplo CI/CD

on: 
  push:
    branches: ["lab","main"]
    tags: ["[0-9]*"]
  pull_request:
    branches: ["lab","main"]
  repository_dispatch:
    types: [deplo-run-remote-job]

env:
  DEPLO_GHACTION_CI_ID: ${{ github.run_id }}-${{ github.run_attempt }}
  DEPLO_GHACTION_PR_URL: ${{ github.event.pull_request.url }}
  DEPLO_GHACTION_EVENT_TYPE: ${{ github.event.action }}
  DEPLO_GHACTION_EVENT_PAYLOAD: ${{ toJSON(github.event.client_payload) }}
  DEPLO_OVERWRITE_COMMIT: ${{ github.event.client_payload.commit }}
  DEPLO_OVERWRITE_RELEASE_TARGET: ${{ github.event.client_payload.release_target }}
  DEPLO_OVERWRITE_VERBOSITY: ${{ github.event.client_payload.verbosity }}
  DEPLO_OVERWRITE_WORKFLOW: ${{ github.event.client_payload.workflow }}
  SUNTOMI_VCS_ACCOUNT: ${{ secrets.SUNTOMI_VCS_ACCOUNT }}
  SUNTOMI_VCS_ACCOUNT_EMAIL: ${{ secrets.SUNTOMI_VCS_ACCOUNT_EMAIL }}
  SUNTOMI_VCS_ACCOUNT_KEY: ${{ secrets.SUNTOMI_VCS_ACCOUNT_KEY }}
jobs:
  deplo-main:
    name: Start CI ${{ github.event.client_payload.job_id }}
    runs-on: ubuntu-latest
    outputs:
      deploy-base: ${{ steps.deplo-ci-kick.outputs.deploy-base }}
      deploy-builder: ${{ steps.deplo-ci-kick.outputs.deploy-builder }}
      deploy-latest: ${{ steps.deplo-ci-kick.outputs.deploy-latest }}
      deploy-mac: ${{ steps.deplo-ci-kick.outputs.deploy-mac }}
      deploy-product: ${{ steps.deplo-ci-kick.outputs.deploy-product }}
      deploy-win: ${{ steps.deplo-ci-kick.outputs.deploy-win }}
      integrate-base: ${{ steps.deplo-ci-kick.outputs.integrate-base }}
      integrate-builder: ${{ steps.deplo-ci-kick.outputs.integrate-builder }}
      integrate-config: ${{ steps.deplo-ci-kick.outputs.integrate-config }}
      integrate-src: ${{ steps.deplo-ci-kick.outputs.integrate-src }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/nightly/deplo-Linux -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
          ref: ${{ github.event.client_payload.commit }}
      - name: Start deplo
        id: deplo-ci-kick
        run: deplo ci kick
      - name: Setup ssh session to debug
        if: ${{ failure() }}
        uses: umegaya/action-tmate@a3d459813f3429bd95fc48bcd980b2fb40f10ad0
        with:
          sudo: true
  deplo-finish:
    name: Cleanup CI
    if: ${{ !failure() && (needs.deploy-base.outputs.need-cleanup || needs.deploy-builder.outputs.need-cleanup || needs.deploy-latest.outputs.need-cleanup || needs.deploy-mac.outputs.need-cleanup || needs.deploy-product.outputs.need-cleanup || needs.deploy-win.outputs.need-cleanup || needs.integrate-base.outputs.need-cleanup || needs.integrate-builder.outputs.need-cleanup || needs.integrate-config.outputs.need-cleanup || needs.integrate-src.outputs.need-cleanup) }}
    needs: ["deplo-main","deploy-base","deploy-builder","deploy-latest","deploy-mac","deploy-product","deploy-win","integrate-base","integrate-builder","integrate-config","integrate-src"]
    runs-on: ubuntu-latest
    env:
      DEPLO_JOB_SYSTEM_OUTPUT_DEPLOY_BASE: ${{ needs.deploy-base.outputs.system }}
      DEPLO_JOB_SYSTEM_OUTPUT_DEPLOY_BUILDER: ${{ needs.deploy-builder.outputs.system }}
      DEPLO_JOB_SYSTEM_OUTPUT_DEPLOY_LATEST: ${{ needs.deploy-latest.outputs.system }}
      DEPLO_JOB_SYSTEM_OUTPUT_DEPLOY_MAC: ${{ needs.deploy-mac.outputs.system }}
      DEPLO_JOB_SYSTEM_OUTPUT_DEPLOY_PRODUCT: ${{ needs.deploy-product.outputs.system }}
      DEPLO_JOB_SYSTEM_OUTPUT_DEPLOY_WIN: ${{ needs.deploy-win.outputs.system }}
      DEPLO_JOB_SYSTEM_OUTPUT_INTEGRATE_BASE: ${{ needs.integrate-base.outputs.system }}
      DEPLO_JOB_SYSTEM_OUTPUT_INTEGRATE_BUILDER: ""
      DEPLO_JOB_SYSTEM_OUTPUT_INTEGRATE_CONFIG: ${{ needs.integrate-config.outputs.system }}
      DEPLO_JOB_SYSTEM_OUTPUT_INTEGRATE_SRC: ${{ needs.integrate-src.outputs.system }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/nightly/deplo-Linux -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Fetch repository cache
        id: fetch-repository-cache
        uses: actions/cache@v2
        with:
          path: .git
          key: deplo-git-v1-${{ github.sha }}
          restore-keys:
            deplo-git-v1-
      - name: Checkout
        if: steps.fetch-repository-cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: ${{ github.event.client_payload.commit }}
      - name: Restore repository from cache
        if: steps.fetch-repository-cache.outputs.cache-hit == 'true'
        run: git reset --hard HEAD
      - name: Cleanup deplo
        id: deplo-ci-fin
        run: deplo ci fin
      - name: Setup ssh session to debug
        if: ${{ failure() }}
        uses: mxschmitt/action-tmate@v3
        with:
          sudo: true
  deploy-base:
    needs: [deplo-main]
    if: ${{ needs.deplo-main.outputs.deploy-base && !failure() }}
    name: Running job deploy-base
    runs-on: ubuntu-latest
  
  
    outputs:
      need-cleanup: ${{ steps.deplo-deploy-base.outputs.need-cleanup }}
      system: ${{ steps.deplo-deploy-base.outputs.system }}
      user: ${{ steps.deplo-deploy-base.outputs.user }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/nightly/deplo-Linux -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
          ref: ${{ github.event.client_payload.commit }}
  
      - name: deploy base
        id: deplo-deploy-base
        run: deplo ci deploy base
      - name: Setup ssh session to debug
        if: ${{ failure() }}
        uses: mxschmitt/action-tmate@v3
        with:
          sudo: true
  deploy-builder:
    needs: [deplo-main]
    if: ${{ needs.deplo-main.outputs.deploy-builder && !failure() }}
    name: Running job deploy-builder
    runs-on: ubuntu-latest
  
  
    outputs:
      need-cleanup: ${{ steps.deplo-deploy-builder.outputs.need-cleanup }}
      system: ${{ steps.deplo-deploy-builder.outputs.system }}
      user: ${{ steps.deplo-deploy-builder.outputs.user }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/nightly/deplo-Linux -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
          ref: ${{ github.event.client_payload.commit }}
  
      - name: deploy builder
        id: deplo-deploy-builder
        run: deplo ci deploy builder
      - name: Setup ssh session to debug
        if: ${{ failure() }}
        uses: mxschmitt/action-tmate@v3
        with:
          sudo: true
  deploy-latest:
    needs: ["deploy-product","deplo-main"]
    if: ${{ needs.deplo-main.outputs.deploy-latest && !failure() }}
    name: Running job deploy-latest
    runs-on: ubuntu-latest
    env:
      DEPLO_JOB_USER_OUTPUT_DEPLOY_PRODUCT: needs.deploy-product.outputs.user
  
    outputs:
      need-cleanup: ${{ steps.deplo-deploy-latest.outputs.need-cleanup }}
      system: ${{ steps.deplo-deploy-latest.outputs.system }}
      user: ${{ steps.deplo-deploy-latest.outputs.user }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/nightly/deplo-Linux -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
          ref: ${{ github.event.client_payload.commit }}
  
      - name: deploy latest
        id: deplo-deploy-latest
        run: deplo ci deploy latest
      - name: Setup ssh session to debug
        if: ${{ failure() }}
        uses: mxschmitt/action-tmate@v3
        with:
          sudo: true
  deploy-mac:
    needs: ["deploy-product","deplo-main"]
    if: ${{ needs.deplo-main.outputs.deploy-mac && !failure() }}
    name: Running job deploy-mac
    runs-on: macos-latest
    env:
      DEPLO_JOB_USER_OUTPUT_DEPLOY_PRODUCT: needs.deploy-product.outputs.user
  
    outputs:
      need-cleanup: ${{ steps.deplo-deploy-mac.outputs.need-cleanup }}
      system: ${{ steps.deplo-deploy-mac.outputs.system }}
      user: ${{ steps.deplo-deploy-mac.outputs.user }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/nightly/deplo-Darwin -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
          ref: ${{ github.event.client_payload.commit }}
      - name: Cache cargo
        id: deplo-cache-cargo
        uses: actions/cache@v2
        with:
          path: |
            target
            ~/.cargo/bin
            ~/.cargo/registry/cache
            ~/.cargo/registry/index
            ~/.cargo/git/db
          key: integrate-build-${{ runner.os }}-v1-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Mark cache result
        if: steps.deplo-cache-cargo.outputs.cache-hit == 'true'
        run: echo "DEPLO_CACHE_CARGO_HIT=true" >> $GITHUB_ENV
      - name: deploy mac
        id: deplo-deploy-mac
        run: deplo ci deploy mac
      - name: Setup ssh session to debug
        if: ${{ failure() }}
        uses: mxschmitt/action-tmate@v3
        with:
          sudo: true
  deploy-product:
    needs: ["deploy-builder","deplo-main"]
    if: ${{ needs.deplo-main.outputs.deploy-product && !failure() }}
    name: Running job deploy-product
    runs-on: ubuntu-latest
    env:
      DEPLO_JOB_USER_OUTPUT_DEPLOY_BUILDER: needs.deploy-builder.outputs.user
  
    outputs:
      need-cleanup: ${{ steps.deplo-deploy-product.outputs.need-cleanup }}
      system: ${{ steps.deplo-deploy-product.outputs.system }}
      user: ${{ steps.deplo-deploy-product.outputs.user }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/nightly/deplo-Linux -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
          ref: ${{ github.event.client_payload.commit }}
  
      - name: deploy product
        id: deplo-deploy-product
        run: deplo ci deploy product
      - name: Setup ssh session to debug
        if: ${{ failure() }}
        uses: mxschmitt/action-tmate@v3
        with:
          sudo: true
  deploy-win:
    needs: ["deploy-product","deplo-main"]
    if: ${{ needs.deplo-main.outputs.deploy-win && !failure() }}
    name: Running job deploy-win
    runs-on: windows-latest
    env:
      DEPLO_JOB_USER_OUTPUT_DEPLOY_PRODUCT: needs.deploy-product.outputs.user
  
    outputs:
      need-cleanup: ${{ steps.deplo-deploy-win.outputs.need-cleanup }}
      system: ${{ steps.deplo-deploy-win.outputs.system }}
      user: ${{ steps.deplo-deploy-win.outputs.user }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/nightly/deplo-Windows.exe -o /usr/bin/deplo
          chmod +x /usr/bin/deplo
        shell: bash
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
          ref: ${{ github.event.client_payload.commit }}
      - name: Cache cargo
        id: deplo-cache-cargo
        uses: actions/cache@v2
        with:
          path: |
            target
            ~/.cargo/bin
            ~/.cargo/registry/cache
            ~/.cargo/registry/index
            ~/.cargo/git/db
          key: integrate-build-${{ runner.os }}-v1-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Mark cache result
        if: steps.deplo-cache-cargo.outputs.cache-hit == 'true'
        run: echo "DEPLO_CACHE_CARGO_HIT=true" >> $GITHUB_ENV
      - name: deploy win
        id: deplo-deploy-win
        run: deplo ci deploy win
        shell: bash
      - name: Setup ssh session to debug
        if: ${{ failure() }}
        uses: mxschmitt/action-tmate@v3
        with:
          sudo: true
  integrate-base:
    needs: [deplo-main]
    if: ${{ needs.deplo-main.outputs.integrate-base && !failure() }}
    name: Running job integrate-base
    runs-on: ubuntu-latest
  
  
    outputs:
      need-cleanup: ${{ steps.deplo-integrate-base.outputs.need-cleanup }}
      system: ${{ steps.deplo-integrate-base.outputs.system }}
      user: ${{ steps.deplo-integrate-base.outputs.user }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/nightly/deplo-Linux -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
          ref: ${{ github.event.client_payload.commit }}
  
      - name: integrate base
        id: deplo-integrate-base
        run: deplo ci integrate base
      - name: Setup ssh session to debug
        if: ${{ failure() }}
        uses: mxschmitt/action-tmate@v3
        with:
          sudo: true
  integrate-builder:
    needs: [deplo-main]
    if: ${{ needs.deplo-main.outputs.integrate-builder && !failure() }}
    name: Running job integrate-builder
    runs-on: ubuntu-latest
  
  
    outputs:
      need-cleanup: ${{ steps.deplo-integrate-builder.outputs.need-cleanup }}
      system: ${{ steps.deplo-integrate-builder.outputs.system }}
      user: ${{ steps.deplo-integrate-builder.outputs.user }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/nightly/deplo-Linux -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
          ref: ${{ github.event.client_payload.commit }}
  
      - name: integrate builder
        id: deplo-integrate-builder
        run: deplo ci integrate builder
      - name: Setup ssh session to debug
        if: ${{ failure() }}
        uses: mxschmitt/action-tmate@v3
        with:
          sudo: true
  integrate-config:
    needs: [deplo-main]
    if: ${{ needs.deplo-main.outputs.integrate-config && !failure() }}
    name: Running job integrate-config
    runs-on: ubuntu-latest
  
  
    outputs:
      need-cleanup: ${{ steps.deplo-integrate-config.outputs.need-cleanup }}
      system: ${{ steps.deplo-integrate-config.outputs.system }}
      user: ${{ steps.deplo-integrate-config.outputs.user }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/nightly/deplo-Linux -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
          ref: ${{ github.event.client_payload.commit }}
  
      - name: integrate config
        id: deplo-integrate-config
        run: deplo ci integrate config
      - name: Setup ssh session to debug
        if: ${{ failure() }}
        uses: mxschmitt/action-tmate@v3
        with:
          sudo: true
  integrate-src:
    needs: ["integrate-config","deplo-main"]
    if: ${{ needs.deplo-main.outputs.integrate-src && !failure() }}
    name: Running job integrate-src
    runs-on: ubuntu-latest
    env:
      DEPLO_JOB_USER_OUTPUT_INTEGRATE_CONFIG: needs.integrate-config.outputs.user
  
    outputs:
      need-cleanup: ${{ steps.deplo-integrate-src.outputs.need-cleanup }}
      system: ${{ steps.deplo-integrate-src.outputs.system }}
      user: ${{ steps.deplo-integrate-src.outputs.user }}
    steps:
      - name: Fetch deplo cli
        run: |
          curl -L https://github.com/suntomi/deplo/releases/download/nightly/deplo-Linux -o /usr/local/bin/deplo
          chmod +x /usr/local/bin/deplo
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
          ref: ${{ github.event.client_payload.commit }}
      - name: Cache cargo
        id: deplo-cache-cargo
        uses: actions/cache@v2
        with:
          path: |
            target
            ~/.cargo/bin
            ~/.cargo/registry/cache
            ~/.cargo/registry/index
            ~/.cargo/git/db
          key: integrate-build-${{ runner.os }}-v1-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Mark cache result
        if: steps.deplo-cache-cargo.outputs.cache-hit == 'true'
        run: echo "DEPLO_CACHE_CARGO_HIT=true" >> $GITHUB_ENV
      - name: integrate src
        id: deplo-integrate-src
        run: deplo ci integrate src
      - name: Setup ssh session to debug
        if: ${{ failure() }}
        uses: mxschmitt/action-tmate@v3
        with:
          sudo: true
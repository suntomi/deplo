# generated by deplo CLI https://github.com/suntomi/deplo don't edit by hand.
version: 2.1

executors:
  deplo:
    machine:
      image: ubuntu-2004:202111-01
    working_directory: /workdir

commands:
  fetch_repo:
    parameters:
      name: 
        type: string
        default: ""
    steps:
      - restore_cache:
          keys:
            - deplo-git-v1-<< parameters.name >>-{{{{ .Revision }}}}
            - deplo-git-v1-<< parameters.name >>-
            - deplo-git-v1-
  setup_repo:
    parameters:
      lfs: 
        type: string
        default: ""
      opts_hash: 
        type: string
        default: ""
    steps:
      - fetch_repo
        opts_hash: << parameters.opts_hash >>
      - checkout
      - run:
          name: 'maintain git'
          command: git gc
      - run:
          name: 'pull files in git LFS if required'
          command: |
            if [ ! -z "<< parameters.lfs >>" ]; then
              git lfs pull
            else
              echo "skip git LFS checkout"
            fi
      - save_cache:
          key: deplo-git-v1<< parameters.opts_hash >>-{{{{ .Revision }}}}
          paths:
            - ".git"

{entrypoint}

jobs:
  deplo-main:
    executor: deplo
    steps:
      - setup_repo
      - run:
          name: Fetch deplo cli
          command: |
            curl -L https://github.com/suntomi/deplo/releases/download/nightly/deplo-Linux-$(uname -m) -o /usr/local/bin/deplo
            chmod +x /usr/local/bin/deplo
      - run:
          name: 'Start Deplo'
          command: deplo ci kick
      - persist_to_workspace:
          root: /tmp/deplo
          paths:
            - marked_jobs
{jobs:>2}

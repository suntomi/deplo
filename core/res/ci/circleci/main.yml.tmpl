version: 2.1

executors:
  deplo:
    working_directory: /workdir
    docker:
      - image: {image}:{tag}

commands:
  fetch_repo:
    parameters:
      name: 
        type: string
        default: ""
    steps:
      - restore_cache:
          keys:
            - deplo-git-v1-<< parameters.name >>-{{{{ .Revision }}}}
            - deplo-git-v1-<< parameters.name >>-
            - deplo-git-v1-
  setup_repo:
    parameters:
      lfs: 
        type: string
        default: ""
      name: 
        type: string
        default: ""
    steps:
      - fetch_repo
        name: << parameters.name >>
      - checkout
      - run:
          name: 'maintain git'
          command: git gc
      - run:
          name: 'pull files in git LFS if required'
          command: |
            if [ ! -z "<< parameters.lfs >>" ]; then
              git lfs pull
            else
              echo "skip git LFS checkout"
            fi
      - save_cache:
          key: deplo-git-v1-<< parameters.name >>-{{{{ .Revision }}}}
          paths:
            - ".git"

{workflows}

jobs:
  deplo-main:
    executor: deplo
    steps:
      - setup_repo
      - run:
          name: 'Start Deplo'
          command: deplo ci kick
{jobs:>2}
